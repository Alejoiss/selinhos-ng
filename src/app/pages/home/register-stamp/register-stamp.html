<app-internal-header [config]="headerConfig"></app-internal-header>

<div class="bg-white p-4 mb-4 w-full flex p-4 justify-center">
    <div class="w-120 items-center justify-center">
        <div class="w-full flex gap-4">
            <div class="w-1/2">
                <button nz-button [nzType]="buttonSelected === 'qrcode' ? 'primary' : 'default'" class="w-full"
                    (click)="selectButton('qrcode')" [disabled]="loading">
                    <i class="ph ph-qr-code mr-2"></i>
                    QR Code
                </button>
            </div>
            <div class="w-1/2">
                <button nz-button [nzType]="buttonSelected === 'manual' ? 'primary' : 'default'" class="w-full"
                    (click)="selectButton('manual')" [disabled]="loading">
                    <i class="ph ph-hand-tap mr-2"></i>
                    Manual
                </button>
            </div>
        </div>

        <form [formGroup]="form">
            <!-- Input da campanha -->
            <div class="w-full-flex mt-4">
                <nz-form-item class="w-full">
                    <nz-form-label nzSpan="campaign" nzRequired>Campanha</nz-form-label>
                    <nz-form-control nzSpan="campaign" nzErrorTip="Por favor selecione a campanha!">
                        <nz-select formControlName="campaign" nzPlaceHolder="Selecione a campanha" nzShowSearch
                            nzAllowClear nzOptionFilterProp="label">
                            @for (campaign of campaigns; track campaign.id) {
                            <nz-option [nzLabel]="campaign.name" [nzValue]="campaign.id"></nz-option>
                            }
                        </nz-select>
                    </nz-form-control>
                </nz-form-item>
            </div>

            @if (buttonSelected === 'manual') {
                <!-- Input do consumer_name (nome do consumidor não cadastrado) -->
                <div class="w-full-flex">
                    <nz-form-item class="w-full">
                        <nz-form-label nzSpan="cpf" nzRequired>CPF do cliente</nz-form-label>
                        <nz-form-control nzSpan="cpf" nzErrorTip="Por favor insira o cpf do cliente!">
                            <input nz-input formControlName="cpf" placeholder="CPF do cliente" class="w-full" mask="000.000.000-00" />
                        </nz-form-control>
                    </nz-form-item>
                </div>
                <!-- Card informativo de usuário encontrado -->
                @if (userSearchStatus === 'success' && foundUser) {
                    <div class="w-full mt-2">
                        <div class="bg-green-50 border border-green-400 rounded-lg p-4 flex items-center gap-4">
                            <i class="ph ph-user-circle text-3xl text-green-500"></i>
                            <div>
                                <div class="font-bold text-green-700">Cliente encontrado</div>
                                <div class="text-green-800">{{ foundUser.first_name }} {{ foundUser.last_name }}</div>
                                <div class="text-green-800">CPF: {{ foundUser.cpf }}</div>
                                <div class="text-green-800">E-mail: {{ foundUser.email }}</div>
                            </div>
                        </div>
                    </div>
                }
                <!-- Card informativo de usuário não encontrado -->
                @if (userSearchStatus === 'warning' && !foundUser) {
                    <div class="w-full mt-2">
                        <div class="bg-yellow-50 border border-yellow-400 rounded-lg p-4 flex items-center gap-4">
                            <i class="ph ph-warning text-3xl text-yellow-500"></i>
                            <div>
                                <div class="font-bold text-yellow-700">Cliente não cadastrado</div>
                                <div class="text-yellow-800">Este CPF não está vinculado a um cliente cadastrado ou ainda não possui selos registrados neste estabelecimento.</div>
                                <div class="text-yellow-800">Os selos serão lançados normalmente, mas informe ao cliente que ele pode realizar o cadastro para acompanhar seus selos.</div>
                            </div>
                        </div>
                    </div>
                }
            }

            <!-- Input do value (valor consumido) -->
            <div class="w-full-flex">
                <nz-form-item class="w-full">
                    <nz-form-label nzSpan="value" nzRequired>Valor consumido</nz-form-label>
                    <nz-form-control nzSpan="value" nzErrorTip="Por favor insira o valor consumido!">
                        <input nz-input formControlName="value" placeholder="Valor consumido" class="w-full"
                            currencyMask [options]="{ prefix: 'R$ ', thousands: '.', decimal: ',', align: 'left' }" />
                    </nz-form-control>
                </nz-form-item>
            </div>

            <!-- Input do número de selos -->
            <div class="w-full-flex">
                <nz-form-item class="w-full">
                    <nz-form-label nzSpan="stamps" nzRequired>Número de selos</nz-form-label>
                    <nz-form-control nzSpan="stamps" nzErrorTip="Por favor insira o número de selos!">
                        <input nz-input formControlName="stamps" placeholder="Número de selos" class="w-full"
                            type="number" min="1" />
                    </nz-form-control>
                </nz-form-item>
            </div>

            @if (buttonSelected === 'manual') {
                <div class="w-full-flex mt-4">
                    <button nz-button nzType="primary" class="w-full" (click)="onSubmit()"
                        [disabled]="form.invalid || loading">
                        <i class="ph ph-plus-circle mr-2"></i>
                        Lançar selos
                        @if (loading) {
                        <i class="ph ph-spinner animate-spin text-base align-middle ml-2"></i>
                        }
                    </button>
                </div>
            }
            @else {
                <div class="w-full-flex mt-4">
                    <button nz-button nzType="primary" class="w-full" (click)="onSubmit()"
                        [disabled]="form.invalid || loading">
                        <i class="ph ph-qr-code mr-2"></i>
                        Gerar QR Code
                        @if (loading) {
                        <i class="ph ph-spinner animate-spin text-base align-middle ml-2"></i>
                        }
                    </button>
                </div>

                @if (qrCodeValue) {
                    <div class="w-full-flex mt-4 flex flex-col items-center cursor-pointer" (click)="showModal()">
                        <span class="mb-4">Peça ao cliente para escanear o QR Code abaixo para registrar os selos:</span>
                        <qr-code [value]="qrCodeValue" size="300" errorCorrectionLevel="M" />
                        (Clique no QR Code para ampliar)
                    </div>
                }
            }
        </form>
    </div>
</div>

<nz-modal [(nzVisible)]="isVisible" nzTitle="QR Code" [nzWidth]="650" [nzFooter]="modalFooter">
    <ng-container *nzModalContent>
        <qr-code [value]="qrCodeValue" size="600" errorCorrectionLevel="M" />
    </ng-container>

    <ng-template #modalFooter>
        <button nz-button nzType="primary" (click)="handleOk()">Fechar</button>
    </ng-template>
</nz-modal>
